{% extends 'base.html.twig' %}

{% block title %}Commande{% endblock %}

{% block body %}
<div class="container my-5">
    <div class="row g-4">
        <!-- Formulaire de commande -->
        <div class="col-md-6">
            <div class="card shadow-lg border-0 rounded-4">
                <div class="card-header bg-primary text-white text-center">
                    <h3 class="mb-0">
                        <i class="bi bi-bag-check me-2"></i>
                        Passer une commande
                    </h3>
                </div>
                <div class="card-body p-4">
                    {{ form_start(form, {'attr': {'class': 'needs-validation'}}) }}

                    <div class="mb-3">
                        {{ form_label(form.firstName, 'Nom', {'label_attr': {'class': 'form-label fw-bold'}}) }}
                        {{ form_widget(form.firstName, {attr:{'class': 'form-control rounded-3 p-2', 'placeholder': 'Votre nom'}}) }}
                    </div>

                    <div class="mb-3">
                        {{ form_label(form.lastName, 'Prénom', {'label_attr': {'class': 'form-label fw-bold'}}) }}
                        {{ form_widget(form.lastName, {attr:{'class': 'form-control rounded-3 p-2', 'placeholder': 'Votre prénom'}}) }}
                    </div>

                    <div class="mb-3">
                        {{ form_label(form.phone, 'Téléphone', {'label_attr': {'class': 'form-label fw-bold'}}) }}
                        {{ form_widget(form.phone, {attr:{'class': 'form-control rounded-3 p-2', 'placeholder': 'Votre téléphone'}}) }}
                    </div>

                    <div class="mb-3">
                        {{ form_label(form.adresse, 'Email', {'label_attr': {'class': 'form-label fw-bold'}}) }}
                        {{ form_widget(form.adresse, {attr:{'class': 'form-control rounded-3 p-2', 'placeholder': 'Votre adresse'}}) }}
                    </div>

                    <div class="mb-3">
                        {{ form_label(form.city, 'Ville', {'label_attr': {'class': 'form-label fw-bold'}}) }}
                        {{ form_widget(form.city, {attr:{'class': 'form-select rounded-3 p-2'}}) }}
                    </div>
                    <div class="form-check mb-3">
                   {{ form_widget(form.payOnDelivery, {'attr': {'class':'form-check-input me-2'}}) }}
                   {{ form_label(form.payOnDelivery, 'Payer à la livraison', {'label_attr': {'class':'form-check-label'}}) }}
                   {{ form_errors(form.payOnDelivery) }}
               </div>

                    <button type="submit" class="btn btn-primary w-100 py-2 rounded-3 shadow-sm">
                        <i class="bi bi-check-circle me-2"></i>
                        Confirmer la commande
                    </button>

                    {{ form_end(form) }}
                </div>
            </div>
        </div>

        <!-- Résumé du panier -->
        <div class="col-md-6">
            <div class="card shadow-lg border-0 rounded-4">
                <div class="card-header bg-success text-white text-center">
                    <h4 class="mb-0">
                        <i class="bi bi-cart me-2"></i>
                        Votre panier
                    </h4>
                </div>
                <div class="card-body p-3">
                    {% if items is not empty %}
                        <ul class="list-group mb-3">
                            {% for item in items %}
                                <li class="list-group-item d-flex justify-content-between align-items-center">
                                    <div>
                                        <strong>{{ item.product.name }}</strong><br>
                                        <small>{{ item.quantity }} × {{ item.product.price }}€</small>
                                    </div>
                                    <span>{{ item.product.price * item.quantity }}€</span>
                                </li>
                            {% endfor %}
                        </ul>
                        <div class="d-flex justify-content-between fw-bold fs-5 mb-3">
                            <span>Total articles</span>
                            <span id="cart-price">{{ total }}€</span>
                        </div>
                        <div class="d-flex justify-content-between fw-bold fs-5 mb-3">
                            <span>Frais de livraison</span>
                           <p> <span id="shippingCost"></span>€</p> 
                        </div>
                        
                        <div class="d-flex justify-content-between fw-bold fs-5 mb-3">
                            <span>Montant total à payer</span>
                             <p><span class="total-price"></span> €</p>
                        </div>
                        
                        <div class="d-flex gap-2 flex-wrap">
                            <a href="" class="btn btn-outline-danger flex-fill">
                                <i class="bi bi-trash me-1"></i> Vider le panier
                            </a>
                            <a href="" class="btn btn-success flex-fill">
                                <i class="bi bi-credit-card me-1"></i> Passer au paiement
                            </a>
                        </div>
                    {% else %}
                        <p class="text-center text-muted">Votre panier est vide.</p>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>

<script src="https://code.jquery.com/jquery-3.7.1.min.js" integrity="sha256-/JqT3SQfawRcv/BIHPThkBvs0OEvtFFmqPF/lYI/Cxo=" crossorigin="anonymous"></script>
<script>
$(document).ready(function () {
   const citySelector =  $('#order_city');
   const cityValue = citySelector.val();
   const url = `http://localhost:8000/city/${cityValue}/shipping/cost`

   function ajaxRequest(url){

     $.ajax({
    url:url,
    type:'GET',
    success:function (response){
        const newResponse = JSON.parse(response);
        if(parseInt(newResponse.status) === 200){
           // console.log(newResponse.status);

            $('#shippingCost').text(newResponse.content);

            const cartPrice = parseInt($('#cart-price').text());
            const shippingCost = parseInt($('#shippingCost').text());
            $('.total-price').text(cartPrice + shippingCost);
           // console.log(shippingCost)
        }
    },
    error:function(xhr, status, error){}
   })

   }
    ajaxRequest(url);
  

   citySelector.on('change', function(){

    const urlUpdate = `http://localhost:8000/city/${$(this).val()}/shipping/cost`;
    ajaxRequest(urlUpdate);
   })
})
</script>
{% endblock %}
